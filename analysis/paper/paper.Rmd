---
title: "The use of lithic assemblages for the definition of short-term occupations in hunter-gatherer prehistory"
author:
  - Nuno Bicho (ICArEHB, University of Algarve, Faro, Portugal) nbicho@ualg.pt
  - JoÃ£o Cascalheira (ICArEHB, University of Algarve, Faro, Portugal) jmcascalheira@ualg.pt
date: '`r Sys.Date()`'
output: 
    bookdown::word_document2: #subsistute by pdf_document2 or hmtl_document2 as necessary
      fig_caption: yes
      reference_docx: "../templates/template2.docx" 
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl"
abstract: |
  Text of abstract
---


```{r, setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  dpi = 300,
  fig.width = 9,
  fig.path = "../figures/"
  )

#library(ShortTermOccupations) # Or use devtools::load_all('.', quiet = T) if your code is in script files, rather than as functions in the `/R` diretory
```

```{r load_libraries, echo = FALSE}

library(dplyr)
library(FactoMineR)
library(factoextra)
library(ggpubr)
library(ggplot2)
library(ggrepel)

```

# The archaeological use of Short-term occupation

```{r table1}

#read table
Table1 <- readr::read_csv("../data/raw_data/traditional_criteria.csv")

#show table
knitr::kable(Table1,
             digits = 2,
             row.names = FALSE,
             caption= "Traditional criteria for estimation of duration of occupation"
             )

```


# Variables and Methods

```{r table2}

#Load dataset
Dataset <- readr::read_csv("../data/raw_data/raw_dataset.csv")

#Calculate frequency variables
Dataset$LithicDensity <- Dataset$Artifacts / Dataset$SampledVolume
Dataset$CoreFreq <- Dataset$Cores / Dataset$Artifacts
Dataset$BlanksFreq <- Dataset$Blanks / Dataset$Artifacts
Dataset$ChipsFreq <- Dataset$Chips / Dataset$Artifacts
Dataset$RetouchFreq <- Dataset$RetouchedTools / Dataset$Artifacts
Dataset$ToolDiversity <- Dataset$ToolTypes / (sqrt(Dataset$RetouchedTools))
Dataset$FeaturesFreq <- Dataset$Features / Dataset$SampledVolume

#Filter variables to show on paper
#Dataset2 <- Dataset[c(1,2,12:18)]

#Show Table 2
knitr::kable(Dataset,
             digits = 2,
             row.names = FALSE,
             caption = "Archaeological data based on variables used in this study"
             )

```

* **EstimatedArea** - The estimated area of an occupation visible in the archaeological context"

* **DepositThickness** - Average thickness of the excavated deposit presented (in meters), where the lithic assemblage and associated features were recovered"


# Results

```{r table3}

#filter traditional variables from dataset
tradvar <- Dataset[c("EstimatedArea","LithicDensity", "RetouchFreq", "ToolDiversity", "DepositThickness")]

#function to bin variables into three equally intervalled classes (Lower, Medium and High) . not for features
classify <- function(x)  cut(x, 
                       breaks=3, labels = c("L", "M", "H"))

#apply function
classes <- apply(tradvar,2,classify)

#bin Features into two classes (Absent, Present)
Features <- cut(Dataset$Features, breaks = c(-1, 0, Inf), labels = c("A", "P"))

#Combine both dfs
Table3 <- cbind.data.frame(Dataset$Sites, classes, Features)
colnames(Table3)[1] <- "Sites"

#show table
knitr::kable(Table3,
             digits = 2,
             row.names = FALSE,
             caption= "Duration of occupation based on traditional criteria (L - Low; M - Medium; H - High; A - Absent, P - Present)"
             )

```

```{r figure1, fig.cap=""}

#Remove Ncuala from de dataset
Dataset <- Dataset[!(Dataset$Sites == 'Ncuala'),]

#Plot sites WABI
Dataset$RetouchFreqPerc <- Dataset$RetouchFreq * 100

ggplot(Dataset, aes(x=Dataset$LithicDensity, y=Dataset$RetouchFreqPerc)) +
  geom_point(shape=16, size=3) +
  labs(title = "Whole Assemblage Behavioral Index", x = "Lithic Volumetric Density (Artifacts/m3) (Log10)", y = "Frequency of Retouched Pieces (Log10)") +
  geom_text_repel(label=Dataset$Sites) +
  geom_smooth(method="lm", level = 0.80, formula = y~x) +
  scale_x_continuous(trans='log10' ) +
  scale_y_continuous(trans='log10',  limits = c(NA,100))

```


```{r PCA}

#Choose variables to include in PCA
vars <- c("LithicDensity", 
          "EstimatedArea", 
          "CoreFreq", 
          "BlanksFreq",
          "ChipsFreq",
          "RetouchFreq", 
          "ToolDiversity", 
          "FeaturesFreq")

ShortTerm <- Dataset[vars]

# Set site names as row.names
row.names(ShortTerm) <- Dataset$Sites

#Run PCA
ShortTerm.pca <- PCA(ShortTerm, scale.unit = TRUE, ncp = 6, graph = FALSE)

```


```{r table4}

#Calculate Eigenvalues
eig.val <- get_eigenvalue(ShortTerm.pca)

#Eigenvalues table
knitr::kable(eig.val,
             digits = 3,
             caption = "Eigen values and percentage of variance for each dimension of PCA"
             )

```

```{r table5}

knitr::kable(ShortTerm.pca$var$contrib[,1:4],
             digits = 2,
             caption = "Variables' contribution for the first four PCA Dimensions"
             )

```

```{r figure2, fig.cap="Contribution of variables for each of the four relevant dimensions from the PCA"}

# Get variables data
var <- get_pca_var(ShortTerm.pca)

#Plot variables contribution to Dim1, Dim2, Dim3 and Dim4
Dim1 <- fviz_contrib(ShortTerm.pca, choice = "var", axes = 1)
Dim2 <- fviz_contrib(ShortTerm.pca, choice = "var", axes = 2)
Dim3 <- fviz_contrib(ShortTerm.pca, choice = "var", axes = 3)
Dim4 <- fviz_contrib(ShortTerm.pca, choice = "var", axes = 4)

Figure2 <- ggarrange(Dim1,
                     Dim2,
                     Dim3,
                     Dim4,
                     ncol = 2,
                     nrow = 2
                     )
Figure2

```

```{r figure3, fig.cap="Correlation plots of variables, between Dimension 1 and 2 (left) and Dimension 3 and 4 (right)"}

#Plot correlation plot of variables
A <- fviz_pca_var(ShortTerm.pca,
                  col.var = "black",
                  title = "Correlation plot: Dim1/Dim2",
                  repel = TRUE
                  )

B <- fviz_pca_var(ShortTerm.pca,
                  col.var = "black",
                  axes = 3:4,
                  title = "Correlation plot: Dim3/Dim4",
                  repel = TRUE
                  )

Figure3 <- ggarrange(A,
                     B,
                     ncol = 2,
                     nrow = 1
                     )
Figure3

```


```{r table7}

knitr::kable(ShortTerm.pca$ind$contrib,
             digits = 2,
             caption = "Sites' contribution for the first four PCA Dimensions"
             )

```

```{r figure4, fig.cap="Biplot for Dimensions 1 and 2"}

#Biplot Dim 1 and Dim 2
fviz_pca_biplot(ShortTerm.pca,
                repel = TRUE,
                col.var = "#e62e00",
                col.ind = "Black",
                axes = c(1, 2),
                ggtheme = theme_grey()
                )

```


```{r figure5, fig.cap="Biplot for Dimensions 3 and 4"}

#Biplot Dim 3 and Dim 4
fviz_pca_biplot(ShortTerm.pca,
                repel = TRUE,
                col.var = "#e62e00",
                col.ind = "Black",
                axes = c(3, 4),
                ggtheme = theme_grey()
                )

```

#Discussion

#Conclusion

#Acknowledgements



##### pagebreak


# References 
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? You may need to change the path value
# if your Rmd is not in analysis/paper/
git2r::repository("../..")
```
